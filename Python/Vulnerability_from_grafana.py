import requests
import json
import time
from html.parser import HTMLParser

# Configurations
GRAFANA_URL = "https://your-grafana-instance.com"
GRAFANA_API = "/api/search"
LDAP_USERNAME = "your-ldap-username"
LDAP_PASSWORD = "your-ldap-password"
FILTER_APPLICATION = "NomDeLApplication"

GOOGLE_SEARCH_URL = "https://www.google.com/search?q="  # URL de base pour Google

# Authentification à Grafana (SSO LDAP)
def authenticate():
    print("Authentification via SSO...")
    response = requests.post(
        f"{GRAFANA_URL}/login",
        json={"user": LDAP_USERNAME, "password": LDAP_PASSWORD},
        headers={"Content-Type": "application/json"}
    )

    if response.status_code == 200:
        token = response.json().get("token")
        print("Authentification réussie. Token récupéré.")
        return token
    else:
        print(f"Échec de l'authentification: {response.text}")
        return None

# Récupération des vulnérabilités depuis Grafana
def get_vulnerabilities(token):
    print(f"Récupération des vulnérabilités pour l'application : {FILTER_APPLICATION}...")
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    response = requests.get(f"{GRAFANA_URL}{GRAFANA_API}?query={FILTER_APPLICATION}", headers=headers)

    if response.status_code == 200:
        vulnerabilities = response.json()
        if vulnerabilities:
            print(f"{len(vulnerabilities)} vulnérabilité(s) trouvée(s).")
            return vulnerabilities
        else:
            print("Aucune vulnérabilité trouvée.")
            return []
    else:
        print(f"Erreur lors de la récupération des vulnérabilités: {response.text}")
        return []

# Sauvegarde des vulnérabilités dans un fichier JSON
def save_to_json(vulnerabilities, filename="vulnerabilities.json"):
    with open(filename, "w", encoding="utf-8") as file:
        json.dump(vulnerabilities, file, indent=4, ensure_ascii=False)
    print(f"Vulnérabilités enregistrées dans {filename}.")

# Parser HTML pour récupérer les premiers liens Google
class GoogleParser(HTMLParser):
    def __init__(self):
        super().__init__()
        self.links = []
        self.recording = False

    def handle_starttag(self, tag, attrs):
        if tag == "a":
            for attr in attrs:
                if attr[0] == "href" and "url?q=" in attr[1]:
                    link = attr[1].split("url?q=")[1].split("&")[0]
                    if "http" in link:
                        self.links.append(link)

    def get_first_link(self):
        return self.links[0] if self.links else "Aucun lien trouvé"

# Recherche Google pour le plan de remédiation
def search_remediation(summary):
    print(f"Recherche du plan de remédiation pour : {summary}...")

    # Effectue une requête Google en simulant un navigateur
    headers = {"User-Agent": "Mozilla/5.0"}
    response = requests.get(GOOGLE_SEARCH_URL + f"remédiation {summary}", headers=headers)

    if response.status_code == 200:
        parser = GoogleParser()
        parser.feed(response.text)
        link = parser.get_first_link()
        print(f"Plan de remédiation trouvé: {link}")
        return link
    else:
        print("Échec de la recherche Google.")
        return None

# Enrichir le fichier JSON avec le plan de remédiation
def enrich_with_remediation(filename="vulnerabilities.json"):
    with open(filename, "r", encoding="utf-8") as file:
        vulnerabilities = json.load(file)

    for vulnerability in vulnerabilities:
        summary = vulnerability.get("summary")
        if summary:
            remediation_link = search_remediation(summary)
            if remediation_link:
                vulnerability["remediation"] = remediation_link
            time.sleep(2)  # Pause pour éviter de surcharger Google

    with open(filename, "w", encoding="utf-8") as file:
        json.dump(vulnerabilities, file, indent=4, ensure_ascii=False)

    print("Les vulnérabilités ont été enrichies avec des plans de remédiation.")

# Exécution du script
if __name__ == "__main__":
    token = authenticate()
    if token:
        vulnerabilities = get_vulnerabilities(token)
        if vulnerabilities:
            save_to_json(vulnerabilities)
            enrich_with_remediation()
